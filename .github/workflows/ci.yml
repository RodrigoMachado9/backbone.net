##
# backbone.net — CI: Lint & Validate
#
# Valida a integridade do código IaC em cada push/PR.
# Não executa deploy (sem acesso ao KVM), apenas validação estática.
##

name: "CI — Lint & Validate"

on:
  push:
    branches: [main]
    paths:
      - "terraform/**"
      - "ansible/**"
      - "scripts/**"
      - ".github/workflows/**"
  pull_request:
    branches: [main]

jobs:
  yaml-lint:
    name: "YAML Lint (Ansible)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint Ansible files
        run: |
          yamllint -d "{extends: relaxed, rules: {line-length: {max: 200}, truthy: disable}}" \
            ansible/inventory/ \
            ansible/playbooks/ \
            ansible/roles/

  ansible-lint:
    name: "Ansible Lint"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Ansible + ansible-lint
        run: |
          pip install ansible ansible-lint
          ansible-galaxy collection install vyos.vyos fortinet.fortios

      - name: Run ansible-lint
        run: |
          cd ansible && ansible-lint playbooks/ roles/ || true
        # NOTE: || true porque algumas regras podem ser opinionated demais
        # para um lab. Remova o || true quando quiser enforcement estrito.

  terraform-validate:
    name: "Terraform Validate"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5"

      - name: Validate modules
        run: |
          for module in terraform/modules/*/; do
            echo "--- Validating $module ---"
            cd "$module"
            terraform init -backend=false 2>/dev/null || true
            terraform validate || echo "⚠️  Validation issues in $module"
            cd - > /dev/null
          done

      - name: Validate lab environment
        run: |
          cd terraform/environments/lab
          terraform init -backend=false 2>/dev/null || true
          terraform validate || echo "⚠️  Validation issues in lab env"

  shellcheck:
    name: "ShellCheck (Scripts)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run ShellCheck
        run: |
          shellcheck scripts/*.sh || true
        # NOTE: || true para não bloquear em warnings menores.
        # Remova quando quiser enforcement estrito.

  summary:
    name: "CI Summary"
    runs-on: ubuntu-latest
    needs: [yaml-lint, terraform-validate, shellcheck]
    if: always()
    steps:
      - name: Report
        run: |
          echo "✅ CI pipeline completed."
          echo "   yaml-lint:           ${{ needs.yaml-lint.result }}"
          echo "   terraform-validate:  ${{ needs.terraform-validate.result }}"
          echo "   shellcheck:          ${{ needs.shellcheck.result }}"
