---
##
# backbone.net ‚Äî Playbook: Valida√ß√£o
# Executa testes de conectividade e protocolo em todos os roteadores
#
# Uso:
#   ansible-playbook playbooks/validate.yml -i inventory/hosts.yml
#   ansible-playbook playbooks/validate.yml -i inventory/hosts.yml --tags ospf
#   ansible-playbook playbooks/validate.yml -i inventory/hosts.yml --tags bgp
#   ansible-playbook playbooks/validate.yml -i inventory/hosts.yml --tags ping
##

- name: "Valida√ß√£o do backbone"
  hosts: vyos_routers
  gather_facts: false

  tasks:
    # --- OSPF ---
    - name: "OSPF ‚Äî Verificar neighbors"
      vyos.vyos.vyos_command:
        commands:
          - show ip ospf neighbor
      register: ospf_result
      tags: [ospf, all]

    - name: "‚úÖ OSPF neighbors"
      ansible.builtin.debug:
        msg: "{{ ospf_result.stdout_lines }}"
      tags: [ospf, all]

    - name: "üîç ASSERT ‚Äî OSPF tem pelo menos um neighbor Full"
      ansible.builtin.assert:
        that:
          - "'Full' in ospf_result.stdout[0]"
        fail_msg: "FALHA: Nenhum OSPF neighbor em estado Full em {{ inventory_hostname }}"
        success_msg: "OK: OSPF neighbor(s) em Full em {{ inventory_hostname }}"
      tags: [ospf, all]

    # --- BGP ---
    - name: "BGP ‚Äî Verificar sessions"
      vyos.vyos.vyos_command:
        commands:
          - show ip bgp summary
      register: bgp_result
      when: bgp is defined
      tags: [bgp, all]

    - name: "‚úÖ BGP summary"
      ansible.builtin.debug:
        msg: "{{ bgp_result.stdout_lines }}"
      when: bgp is defined
      tags: [bgp, all]

    - name: "üîç ASSERT ‚Äî BGP session Established"
      ansible.builtin.assert:
        that:
          - "'Established' in bgp_result.stdout[0] or 'established' in bgp_result.stdout[0]"
        fail_msg: "FALHA: Nenhuma sess√£o BGP Established em {{ inventory_hostname }}"
        success_msg: "OK: BGP session(s) Established em {{ inventory_hostname }}"
      when: bgp is defined
      tags: [bgp, all]

    # --- Connectivity ---
    - name: "PING ‚Äî Testar conectividade com edge-a LAN"
      vyos.vyos.vyos_command:
        commands:
          - "ping 10.10.1.1 count 3"
      register: ping_a
      ignore_errors: true
      tags: [ping, all]

    - name: "PING ‚Äî Testar conectividade com edge-b LAN"
      vyos.vyos.vyos_command:
        commands:
          - "ping 10.10.2.1 count 3"
      register: ping_b
      ignore_errors: true
      tags: [ping, all]

    - name: "PING ‚Äî Testar conectividade com edge-c LAN"
      vyos.vyos.vyos_command:
        commands:
          - "ping 10.10.3.1 count 3"
      register: ping_c
      ignore_errors: true
      tags: [ping, all]

    - name: "‚úÖ Ping results"
      ansible.builtin.debug:
        msg:
          - "edge-a (10.10.1.1): {{ 'OK' if ping_a.rc == 0 else 'FAIL' }}"
          - "edge-b (10.10.2.1): {{ 'OK' if ping_b.rc == 0 else 'FAIL' }}"
          - "edge-c (10.10.3.1): {{ 'OK' if ping_c.rc == 0 else 'FAIL' }}"
      tags: [ping, all]

    - name: "üîç ASSERT ‚Äî Ping fim-a-fim OK"
      ansible.builtin.assert:
        that:
          - "ping_a.rc == 0"
          - "ping_b.rc == 0"
          - "ping_c.rc == 0"
        fail_msg: "FALHA: Conectividade fim-a-fim incompleta em {{ inventory_hostname }}"
        success_msg: "OK: Todos os pings fim-a-fim responderam em {{ inventory_hostname }}"
      tags: [ping, all]

    # --- Routes ---
    - name: "ROUTES ‚Äî Tabela de rotas"
      vyos.vyos.vyos_command:
        commands:
          - show ip route
      register: routes
      tags: [routes]

    - name: "‚úÖ Routing table"
      ansible.builtin.debug:
        msg: "{{ routes.stdout_lines }}"
      tags: [routes]

    - name: "üîç ASSERT ‚Äî Rota para todas as LANs presente"
      ansible.builtin.assert:
        that:
          - "'10.10.1.0' in routes.stdout[0]"
          - "'10.10.2.0' in routes.stdout[0]"
          - "'10.10.3.0' in routes.stdout[0]"
        fail_msg: "FALHA: Tabela de rotas incompleta em {{ inventory_hostname }} ‚Äî faltam rotas para LANs"
        success_msg: "OK: Rotas para todas as LANs presentes em {{ inventory_hostname }}"
      tags: [routes]
