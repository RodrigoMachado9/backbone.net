---
##
# backbone.net â€” Playbook: Teste de Failover Automatizado
#
# Simula queda do link inter-core (core-dc1 eth0) e valida que:
#   1. TrÃ¡fego reconverge via caminho alternativo
#   2. Todas as LANs continuam acessÃ­veis
#   3. Link Ã© restaurado ao final
#
# Uso:
#   ansible-playbook playbooks/test-failover.yml -i inventory/hosts.yml
#
# âš ï¸  Este playbook DESABILITA temporariamente a interface eth0 de core-dc1.
#     Certifique-se de que o lab estÃ¡ estÃ¡vel antes de executar.
##

- name: "Failover Test â€” Fase 1: ValidaÃ§Ã£o prÃ©-falha"
  hosts: vyos_routers
  gather_facts: false

  tasks:
    - name: "PRE-CHECK â€” Ping edge-a â†’ edge-c (via core)"
      vyos.vyos.vyos_command:
        commands:
          - "ping 10.10.3.1 count 3"
      register: pre_ping
      when: inventory_hostname == 'edge-a'

    - name: "ğŸ” ASSERT â€” Conectividade OK antes da falha"
      ansible.builtin.assert:
        that:
          - "pre_ping.rc == 0"
        fail_msg: "FALHA: Conectividade jÃ¡ estÃ¡ quebrada ANTES do teste. Corrija antes de prosseguir."
        success_msg: "OK: Conectividade fim-a-fim validada prÃ©-falha."
      when: inventory_hostname == 'edge-a'

    - name: "PRE-CHECK â€” Traceroute edge-a â†’ edge-c (path original)"
      vyos.vyos.vyos_command:
        commands:
          - "traceroute 10.10.3.1"
      register: pre_traceroute
      when: inventory_hostname == 'edge-a'

    - name: "ğŸ“ Path original (prÃ©-falha)"
      ansible.builtin.debug:
        msg: "{{ pre_traceroute.stdout_lines }}"
      when: inventory_hostname == 'edge-a'

- name: "Failover Test â€” Fase 2: Simular queda do link inter-core"
  hosts: core-dc1
  gather_facts: false

  tasks:
    - name: "âš¡ FALHA â€” Desabilitar eth0 (link inter-core) em core-dc1"
      vyos.vyos.vyos_config:
        lines:
          - "set interfaces ethernet eth0 disable"

    - name: "â³ Aguardar reconvergÃªncia OSPF (45s)"
      ansible.builtin.pause:
        seconds: 45
        prompt: "Aguardando OSPF reconverger apÃ³s queda de eth0 em core-dc1..."

- name: "Failover Test â€” Fase 3: ValidaÃ§Ã£o pÃ³s-falha"
  hosts: vyos_routers
  gather_facts: false

  tasks:
    - name: "POST-CHECK â€” Ping edge-a â†’ edge-c (deve reconverger)"
      vyos.vyos.vyos_command:
        commands:
          - "ping 10.10.3.1 count 5"
      register: post_ping
      when: inventory_hostname == 'edge-a'
      ignore_errors: true

    - name: "ğŸ” ASSERT â€” Conectividade MANTIDA apÃ³s falha"
      ansible.builtin.assert:
        that:
          - "post_ping.rc == 0"
        fail_msg: "FALHA CRÃTICA: Conectividade perdida apÃ³s queda do link inter-core!"
        success_msg: "âœ… SUCESSO: TrÃ¡fego reconvergiu via caminho alternativo."
      when: inventory_hostname == 'edge-a'

    - name: "POST-CHECK â€” Traceroute edge-a â†’ edge-c (novo path)"
      vyos.vyos.vyos_command:
        commands:
          - "traceroute 10.10.3.1"
      register: post_traceroute
      when: inventory_hostname == 'edge-a'

    - name: "ğŸ“ Path alternativo (pÃ³s-falha)"
      ansible.builtin.debug:
        msg: "{{ post_traceroute.stdout_lines }}"
      when: inventory_hostname == 'edge-a'

    - name: "POST-CHECK â€” Verificar OSPF neighbors (devem ter mudado)"
      vyos.vyos.vyos_command:
        commands:
          - show ip ospf neighbor
      register: post_ospf

    - name: "ğŸ“‹ OSPF neighbors pÃ³s-falha"
      ansible.builtin.debug:
        msg: "{{ post_ospf.stdout_lines }}"

    - name: "POST-CHECK â€” Ping para todas as LANs"
      vyos.vyos.vyos_command:
        commands:
          - "ping 10.10.1.1 count 3"
          - "ping 10.10.2.1 count 3"
          - "ping 10.10.3.1 count 3"
      register: post_all_pings
      ignore_errors: true

- name: "Failover Test â€” Fase 4: Restaurar link"
  hosts: core-dc1
  gather_facts: false

  tasks:
    - name: "ğŸ”§ RESTORE â€” Reabilitar eth0 (link inter-core) em core-dc1"
      vyos.vyos.vyos_config:
        lines:
          - "delete interfaces ethernet eth0 disable"

    - name: "â³ Aguardar reconvergÃªncia OSPF (30s)"
      ansible.builtin.pause:
        seconds: 30
        prompt: "Aguardando OSPF reconverger apÃ³s restauraÃ§Ã£o de eth0 em core-dc1..."

- name: "Failover Test â€” Fase 5: ValidaÃ§Ã£o pÃ³s-restauraÃ§Ã£o"
  hosts: vyos_routers
  gather_facts: false

  tasks:
    - name: "RESTORE-CHECK â€” OSPF neighbors (devem voltar ao normal)"
      vyos.vyos.vyos_command:
        commands:
          - show ip ospf neighbor
      register: restore_ospf

    - name: "ğŸ“‹ OSPF neighbors pÃ³s-restauraÃ§Ã£o"
      ansible.builtin.debug:
        msg: "{{ restore_ospf.stdout_lines }}"

    - name: "RESTORE-CHECK â€” Ping fim-a-fim completo"
      vyos.vyos.vyos_command:
        commands:
          - "ping 10.10.1.1 count 3"
          - "ping 10.10.2.1 count 3"
          - "ping 10.10.3.1 count 3"
      register: restore_pings
      ignore_errors: true

    - name: "ğŸ” ASSERT â€” Conectividade restaurada"
      ansible.builtin.assert:
        that:
          - "restore_pings.rc == 0"
        fail_msg: "FALHA: Conectividade NÃƒO restaurada apÃ³s reabilitar link!"
        success_msg: "âœ… SUCESSO: Backbone completamente restaurado."

    - name: "ğŸ‰ RESULTADO FINAL"
      ansible.builtin.debug:
        msg: >
          Teste de failover concluÃ­do com sucesso!
          - Link inter-core desabilitado â†’ trÃ¡fego reconvergiu
          - Link restaurado â†’ backbone voltou ao estado original
          - ResiliÃªncia dual-core validada.
      when: inventory_hostname == 'edge-a'
